<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP Latencies</title>

  <style>
    :root { color-scheme: light dark; }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 18px; font-size: 30px; }
    h2 { margin: 0 0 14px; font-size: 18px; }
    h3 { margin: 18px 0 10px; font-size: 18px; }

    .card {
      margin: 18px 0 24px;
      padding: 22px;
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.40);
    }

    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 50px; align-items: center; text-align: center; }
    .label { font-weight: 650; opacity: .92; }

    .overhead-value { font-size: 39px; font-weight: 850; margin-top: 6px; letter-spacing: .2px; }
    .green { color: #6dd56d; }
    .orange { color: #ffb347; }
    .red { color: #ff6b6b; }

    .muted { opacity: .85; font-variant-numeric: tabular-nums; }

    /* Response badges bovenaan */
    .response-item { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .response-item img { width: 360px; height: auto; display: block; }

    /* History charts */
    .chart-grid { display: grid; grid-template-columns: 1fr; gap: 18px; margin-top: 6px; }
    .chart-row {
      display: grid;
      grid-template-columns: 160px 1fr 240px;
      gap: 14px;
      align-items: center;
    }
    .chart-box {
      border-radius: 12px;
      background: rgba(127,127,127,.10);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px;
    }
    .legend {
      display: flex;
      gap: 12px;
      justify-content: flex-start;
      align-items: center;
      margin: 6px 0 0;
      font-size: 12px;
      opacity: .85;
    }
    .dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
    .dot-direct { background: rgba(96, 165, 250, .9); }
    .dot-indirect { background: rgba(255, 255, 255, .85); }

    .right-text { text-align: right; white-space: nowrap; }

    /* One-table layout */
    .section { margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(127,127,127,.35); }

    table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 10px; }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(127,127,127,.25);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }
    th {
      text-align: left;
      font-weight: 650;
      position: sticky;
      top: 0;
      backdrop-filter: blur(6px);
      background: rgba(127,127,127,.10);
      z-index: 1;
    }
    td img { height: 20px; vertical-align: middle; }

    @media (max-width: 1100px) {
      .grid-3 { grid-template-columns: 1fr; text-align: left; }
      .response-item { align-items: flex-start; }
      .response-item img { width: 100%; max-width: 420px; }
      .chart-row { grid-template-columns: 1fr; }
      .right-text { text-align: left; }
    }
  </style>
</head>

<body>
  <h1>ERP Latencies</h1>

  <!-- OVERHEAD -->
  <div class="card">
    <h2>Indirect overhead (middleware − direct)</h2>
    <div class="grid-3">
      <div>
        <div class="label">Companies</div>
        <div id="overhead-companies" class="overhead-value">–</div>
      </div>
      <div>
        <div class="label">Articles</div>
        <div id="overhead-articles" class="overhead-value">–</div>
      </div>
      <div>
        <div class="label">Availabilities</div>
        <div id="overhead-availabilities" class="overhead-value">–</div>
      </div>
    </div>
  </div>

  <!-- 30-min HISTORY CHARTS -->
  <div class="card">
    <h2>Historie laatste 30 minuten (1 meting per minuut)</h2>

    <div class="chart-grid">

      <div class="chart-row">
        <div class="label">Companies</div>
        <div class="chart-box">
          <div id="chart-companies"></div>
          <div class="legend">
            <span><span class="dot dot-direct"></span> Direct</span>
            <span><span class="dot dot-indirect"></span> Indirect (middleware)</span>
          </div>
        </div>
        <div class="right-text muted" id="chart-companies-text">–</div>
      </div>

      <div class="chart-row">
        <div class="label">Articles</div>
        <div class="chart-box">
          <div id="chart-articles"></div>
          <div class="legend">
            <span><span class="dot dot-direct"></span> Direct</span>
            <span><span class="dot dot-indirect"></span> Indirect (middleware)</span>
          </div>
        </div>
        <div class="right-text muted" id="chart-articles-text">–</div>
      </div>

      <div class="chart-row">
        <div class="label">Availabilities</div>
        <div class="chart-box">
          <div id="chart-availabilities"></div>
          <div class="legend">
            <span><span class="dot dot-direct"></span> Direct</span>
            <span><span class="dot dot-indirect"></span> Indirect (middleware)</span>
          </div>
        </div>
        <div class="right-text muted" id="chart-availabilities-text">–</div>
      </div>

    </div>

    <div class="muted" style="margin-top:10px;">
      Tip: historie is per browser (localStorage). Eerste 30 minuten “vult” de grafiek.
    </div>
  </div>

  <!-- TOP RESPONSES -->
  <div class="card">
    <h2>Direct – Response</h2>
    <div class="grid-3" id="top-direct"></div>

    <div style="height:28px;"></div>

    <h2>Indirect (middleware) – Response</h2>
    <div class="grid-3" id="top-indirect"></div>
  </div>

  <!-- ONE TABLE -->
  <div class="section">
    <h3>Alle monitoren</h3>

    <table>
      <colgroup>
        <col style="width: 210px;">
        <col style="width: 140px;">
        <col style="width: 160px;">
        <col style="width: 240px;">
        <col style="width: 250px;">
        <col style="width: 280px;">
        <col style="width: 170px;">
        <col style="width: 140px;">
      </colgroup>

      <thead>
        <tr>
          <th>Route</th>
          <th>Categorie</th>
          <th>Status</th>
          <th>Uptime</th>
          <th>Ping</th>
          <th>Avg response</th>
          <th>Cert exp</th>
          <th>Response</th>
        </tr>
      </thead>

      <tbody id="tbody-all"></tbody>
    </table>
  </div>

  <script>
    const base = "https://vrooamstatus.nl/api/badge";

    const rows = [
      { route: "Direct", category: "companies",      id: 349 },
      { route: "Direct", category: "articles",       id: 351 },
      { route: "Direct", category: "availabilities", id: 352 },

      { route: "Indirect (middleware)", category: "companies",      id: 184 },
      { route: "Indirect (middleware)", category: "articles",       id: 185 },
      { route: "Indirect (middleware)", category: "availabilities", id: 350 },
    ];

    const map = {
      companies:      { direct: 349, indirect: 184 },
      articles:       { direct: 351, indirect: 185 },
      availabilities: { direct: 352, indirect: 350 },
    };

    const metrics = ["status","uptime","ping","avg-response","cert-exp","response"];

    // --- helpers ---
    function badgeUrl(id, metric) { return `${base}/${id}/${metric}`; }

    function withBust(url) {
      const sep = url.includes("?") ? "&" : "?";
      return `${url}${sep}t=${Date.now()}`;
    }

    function badgeCell(id, metric) {
      return `<td><img data-badge="1" src="${withBust(badgeUrl(id, metric))}" loading="lazy" alt="${metric} ${id}"></td>`;
    }

    function rowHtml(r) {
      const cells = metrics.map(m => badgeCell(r.id, m)).join("");
      return `<tr>
        <td><strong>${r.route}</strong></td>
        <td><strong>${r.category}</strong></td>
        ${cells}
      </tr>`;
    }

    function topCard(category, id) {
      return `<div class="response-item">
        <div class="label">${category} (${id})</div>
        <img data-badge="1" src="${withBust(badgeUrl(id, "response"))}" loading="lazy" alt="response ${id}">
      </div>`;
    }

    function refreshAllBadgeImages() {
      document.querySelectorAll('img[data-badge="1"]').forEach(img => {
        const baseSrc = img.src.split("?")[0];
        img.src = withBust(baseSrc);
      });
    }

    function overheadTone(diff) {
      if (diff < 50) return "green";
      if (diff < 150) return "orange";
      return "red";
    }

    function setOverheadValue(category, diff) {
      const el = document.getElementById(`overhead-${category}`);
      el.classList.remove("green","orange","red");
      el.textContent = `${diff} ms`;
      el.classList.add(overheadTone(diff));
    }

    async function fetchMsFromBadge(id) {
      const res = await fetch(withBust(badgeUrl(id, "response")), { cache: "no-store" });
      const svg = await res.text();
      const m = svg.match(/(\d+)\s*ms/i);
      return m ? parseInt(m[1], 10) : null;
    }

    // --- history storage ---
    const HISTORY_MINUTES = 30;
    const HISTORY_KEY = "erpLatencyHistoryV1";

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return { companies: [], articles: [], availabilities: [] };
        const obj = JSON.parse(raw);
        return {
          companies: Array.isArray(obj.companies) ? obj.companies : [],
          articles: Array.isArray(obj.articles) ? obj.articles : [],
          availabilities: Array.isArray(obj.availabilities) ? obj.availabilities : [],
        };
      } catch {
        return { companies: [], articles: [], availabilities: [] };
      }
    }

    function saveHistory(h) {
      try { localStorage.setItem(HISTORY_KEY, JSON.stringify(h)); } catch {}
    }

    function trimHistory(arr) {
      const cutoff = Date.now() - (HISTORY_MINUTES * 60 * 1000);
      const trimmed = arr.filter(p => p && typeof p.t === "number" && p.t >= cutoff);
      // extra safety: max 30-ish points
      return trimmed.slice(-HISTORY_MINUTES);
    }

    function upsertPoint(arr, point) {
      // als we binnen dezelfde minuut al een punt hebben, overschrijf laatste
      if (arr.length > 0) {
        const last = arr[arr.length - 1];
        if (Math.abs(point.t - last.t) < 45 * 1000) {
          arr[arr.length - 1] = point;
          return arr;
        }
      }
      arr.push(point);
      return arr;
    }

    // --- simple SVG chart ---
    function renderHistoryChart(containerId, points, latestDirect, latestIndirect) {
      const el = document.getElementById(containerId);

      const width = 820;
      const height = 120;
      const padL = 10, padR = 10, padT = 10, padB = 18;

      // we verwachten points: [{t, d, i}]
      const data = points.slice(-HISTORY_MINUTES);

      if (data.length < 2) {
        el.innerHTML = `<div class="muted">Nog geen historie (minimaal 2 meetpunten nodig).</div>`;
        return;
      }

      // schaal: neem max van direct/indirect in window, plus beetje ruimte
      const maxVal = Math.max(1, ...data.flatMap(p => [p.d || 0, p.i || 0]), latestDirect || 0, latestIndirect || 0);
      const yMax = Math.ceil(maxVal * 1.15);

      const innerW = width - padL - padR;
      const innerH = height - padT - padB;

      function xAt(idx) {
        return padL + (idx / (data.length - 1)) * innerW;
      }
      function yAt(val) {
        const v = Math.max(0, val);
        return padT + (1 - (v / yMax)) * innerH;
      }

      function pathFor(key) {
        return data.map((p, idx) => {
          const v = key === "d" ? p.d : p.i;
          const x = xAt(idx);
          const y = yAt(v);
          return `${idx === 0 ? "M" : "L"} ${x.toFixed(2)} ${y.toFixed(2)}`;
        }).join(" ");
      }

      // simpele y-as labels (0, 50%, 100%)
      const y0 = yAt(0);
      const yMid = yAt(yMax * 0.5);
      const yTop = yAt(yMax);

      const directPath = pathFor("d");
      const indirectPath = pathFor("i");

      el.innerHTML = `
        <svg viewBox="0 0 ${width} ${height}" width="100%" height="120" role="img" aria-label="Latency history chart">
          <!-- grid -->
          <line x1="${padL}" y1="${y0}" x2="${width-padR}" y2="${y0}" stroke="rgba(255,255,255,.10)" />
          <line x1="${padL}" y1="${yMid}" x2="${width-padR}" y2="${yMid}" stroke="rgba(255,255,255,.07)" />
          <line x1="${padL}" y1="${yTop}" x2="${width-padR}" y2="${yTop}" stroke="rgba(255,255,255,.10)" />

          <!-- y labels -->
          <text x="${padL}" y="${yTop+12}" fill="rgba(255,255,255,.55)" font-size="11">${yMax}ms</text>
          <text x="${padL}" y="${yMid+12}" fill="rgba(255,255,255,.45)" font-size="11">${Math.round(yMax*0.5)}ms</text>
          <text x="${padL}" y="${y0+12}" fill="rgba(255,255,255,.45)" font-size="11">0ms</text>

          <!-- indirect line (wit) -->
          <path d="${indirectPath}" fill="none" stroke="rgba(255,255,255,.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>

          <!-- direct line (blauw) -->
          <path d="${directPath}" fill="none" stroke="rgba(96,165,250,.95)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>

          <!-- last point markers -->
          <circle cx="${xAt(data.length-1)}" cy="${yAt(data[data.length-1].i)}" r="3.3" fill="rgba(255,255,255,.90)"/>
          <circle cx="${xAt(data.length-1)}" cy="${yAt(data[data.length-1].d)}" r="3.3" fill="rgba(96,165,250,.98)"/>
        </svg>
      `;
    }

    function setChartText(category, d, i) {
      const el = document.getElementById(`chart-${category}-text`);
      if (d == null || i == null) { el.textContent = "–"; return; }
      const overhead = i - d;
      el.textContent = `Direct ${d} ms • Indirect ${i} ms • Overhead ${overhead} ms`;
    }

    // --- render static parts once ---
    function renderOnce() {
      // responses
      const topDirect = document.getElementById("top-direct");
      const topIndirect = document.getElementById("top-indirect");
      topDirect.innerHTML = "";
      topIndirect.innerHTML = "";

      for (const c of ["companies","articles","availabilities"]) {
        topDirect.insertAdjacentHTML("beforeend", topCard(c, map[c].direct));
        topIndirect.insertAdjacentHTML("beforeend", topCard(c, map[c].indirect));
      }

      // table
      document.getElementById("tbody-all").innerHTML = rows.map(rowHtml).join("");
    }

    // --- main tick (every minute) ---
    async function tick() {
      refreshAllBadgeImages();

      // measure current
      const history = loadHistory();

      // fetch all at once
      const categories = ["companies","articles","availabilities"];
      const fetched = {};

      await Promise.all(categories.map(async (c) => {
        const [d, i] = await Promise.all([
          fetchMsFromBadge(map[c].direct),
          fetchMsFromBadge(map[c].indirect),
        ]);
        if (d == null || i == null) return;
        fetched[c] = { d, i };
      }));

      // update history
      const now = Date.now();
      for (const c of categories) {
        if (!fetched[c]) continue;
        const point = { t: now, d: fetched[c].d, i: fetched[c].i };
        history[c] = upsertPoint(trimHistory(history[c]), point);
      }
      saveHistory(history);

      // update overhead cards + charts
      for (const c of categories) {
        if (!fetched[c]) continue;

        const d = fetched[c].d;
        const i = fetched[c].i;
        const overhead = i - d;

        setOverheadValue(c, overhead);
        setChartText(c, d, i);
        renderHistoryChart(`chart-${c}`, history[c], d, i);
      }
    }

    renderOnce();
    tick();
    setInterval(tick, 60000);
  </script>
</body>
</html>
